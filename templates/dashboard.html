{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}
{% block content %}
<div>
  <h1>Dashboard {% if collection %}for collection {{collection.name}}{%endif%}</h1>
  <h2>Analysis applied to entities</h2>
  <form name="tasks" hx-post="/f{{collection.path}}/dashboard" hx-target="#content">
  {% if user_can('admin') %}
  <input type='radio' name="action" value="trigger" checked onchange="set_state(this.value)">Trigger tasks</input>
  <input type='radio' name="action" value="delete" onchange="set_state(this.value)">Delete all task data</input>
  <button type="submit">Submit</button>
  {% else %}
  <input type='hidden' name='action' value='trigger'/>
  <button type="submit">Trigger tasks</button>
  {% endif %}

  <table>
    <tr>
    {% if user_can('admin') %}<td></td>{%endif%}
    <th>Entity <span style="font-weight: normal">(Task)</span> \ Status</th>
    {%for status in process_status %}
      <th style="padding-right: 1ex;">{{status.name}}</th>
    {%endfor%}
    <th>Total</th>
    </tr>
    {% if user_can('admin') %}
    <tr>
      <td></td>
      <td></td>
      {% for status in process_status %}
      <td style="text-align: center;">
      {% if status.name not in no_action_status %}
      <input type="checkbox" name="status_{{status.name}}"/>
      {% endif %}
      </td>
      {% endfor %}
      <td></td>
    </tr>
    {% endif %}
  {% for (topic_type, topic_count) in content.items() %}
  {%set analyzers=target_topics[topic_type]%}
  <tr>
    {% if user_can('admin') %}<td></td>{%endif%}
    <th colspan="8">{{topic_type.name}}</th>
    <th>{{content[topic_type]}}</th>
  </tr>

    {% for ((analyzer, version, template), status_d) in analyzers.items() %}
    <tr>
      {% if user_can('admin') %}<td><input type="checkbox" name="task__{{analyzer}}__{{version}}__{{template or ''}}"/></td>{%endif%}
      <td>{{analyzer}}
      {%if versions[analyzer] %}v{{version}}{%endif%}
      {%if template%}({{template}}){%endif%}
      </td>
      {%for status in process_status %}
        <td style="text-align: center;">
        {%if status in status_d %}
          {{status_d[status][0]}}
        {% if status_d[status][1] and status_d[status][1]!= status_d[status][0] %}({{status_d[status][1]}}){%endif%}
        {%endif%}

        {#
        {%set (col, val) = target_topics_control[topic_type][(analyzer, version, template)][status]%}
        {%if control and control != status_d[status][col] %}
        <span style="color: {{'red' if col else 'orange'}};">{{control}}</span>
        {%endif%}
        #}
        </td>
      {%endfor%}
      <td></td>
    </tr>
    {% endfor %}
  </tr>
  {% endfor %}
  </table>
  </form>

  <h2>Entities generated by analysis</h2>
  <ul>
  {% for (status, analyzer_name, analyzer_version, template_nickname, topic_type, topic_count, analysis_count) in generated_topics %}
    <li>
    {{analyzer_name}} v{{analyzer_version}}
    {% if template_nickname %}
    - {{template_nickname}}
    {% endif %}
    [{{status.name}}]:
    {% if topic_type %}
    {{topic_count}} {{topic_type.name}} {%if analysis_count and analysis_count != topic_count %}({{analysis_count}} analyses){%endif%}
    {% else %}
    None ({{analysis_count}} analyses)
    {% endif %}
    </li>
  {% endfor %}
  </ul>


</div>
{% endblock %}
{% block script_content %}
  const bulk_tasks = {{bulk_tasks|safe}};
  const deletable_tasks = {{deletable_tasks|safe}};
  const bulk_status = {{bulk_status|safe}};
  const deletable_status = {{deletable_status|safe}};
  function set_state(action) {
    const statuses = (action == 'trigger')?bulk_status:deletable_status;
    const tasks = (action=='trigger')?bulk_tasks:deletable_tasks;
    for (const el of document.tasks) {
      if (el.type == 'checkbox') {
        if (el.name.startsWith('status_')) {
          const status = el.name.substring(7);
          if (statuses.indexOf(status) >= 0) {
            el.disabled = false;
          } else {
            el.disabled = true;
            el.checked = false;
          }
        } else if (el.name.startsWith('task__')) {
          const parts = el.name.split('__')
          const task = parts[1];
          if (tasks.indexOf(task) >= 0) {
            el.disabled = false;
          } else {
            el.disabled = true;
            el.checked = false;
          }
        }
      }
    }
  }
  function loaded() {
    setPagination(null, null, false);
    set_state('trigger')
  }
  function onPaginate(direction) {}

{% endblock %}
